<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Browser LLM Chat + PDF & RAG</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#0b0b0c;color:#f1f1f3}
  header{background:#111;padding:14px 20px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
  main{max-width:1100px;margin:0 auto;padding:18px}
  select,input,button,textarea{background:#161618;color:#f1f1f3;border:1px solid #2a2a2f;border-radius:10px;padding:10px;font-size:14px}
  textarea{width:100%;min-height:80px;resize:vertical}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start}
  .input-group{display:flex;flex-direction:column;min-width:260px}
  .row{display:flex;gap:10px;margin-top:10px}
  .role{width:84px;color:#aaa;font-size:12px;text-transform:uppercase}
  .bubble{background:#131316;border:1px solid #2a2a2f;border-radius:14px;padding:10px 14px;flex:1;white-space:pre-wrap}
  #progress{height:6px;background:#1a1a1d;border-radius:3px;overflow:hidden;margin:8px 0}
  #bar{height:100%;width:0%;background:#4da3ff;transition:width .25s ease}
  .hint{color:#9aa0a6;font-size:12px}
  .small{font-size:12px;padding:6px 8px;border-radius:8px}
  optgroup[label]{color:#b6c8ff;font-weight:600;font-style:normal}
  .panel{border:1px solid #2a2a2f;border-radius:12px;padding:12px;background:#121214}
  .list{max-height:220px;overflow:auto;border:1px solid #2a2a2f;border-radius:10px;margin-top:8px}
  .list table{width:100%;border-collapse:collapse}
  .list th,.list td{padding:6px 8px;border-bottom:1px solid #24242a;font-size:13px}
  .dropzone{border:1px dashed #2a2a2f;border-radius:12px;padding:12px;background:#121214;color:#cfd3da;text-align:center}
  .dropzone.drag{background:#172033;border-color:#355a9a}
</style>
</head>
<body>
<header>
  <div><b>Browser LLM Chat</b> <span class="hint">ï¼ˆWebGPUã§ãƒ­ãƒ¼ã‚«ãƒ«æ¨è«–ï¼‹PDFæŠ½å‡ºï¼‹RAGï¼‰</span></div>
  <div id="gpu" class="hint">GPU: æ¤œå‡ºä¸­â€¦</div>
</header>

<main>
  <!-- ====== LLM æ“ä½œãƒãƒ¼ ====== -->
  <div class="toolbar">
    <div class="input-group" style="min-width:360px;">
      <label>ãƒ¢ãƒ‡ãƒ«<select id="model"></select></label>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px;">
        <label class="hint"><input type="checkbox" id="onlyDownloaded"> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®ã¿è¡¨ç¤º</label>
        <button id="refresh" class="small">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
        <span class="hint">â˜…=ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ / 7Bã¾ã§è‡ªå‹•æŠ½å‡º</span>
      </div>
    </div>
    <div class="input-group">
      <label>æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³<input type="number" id="maxTokens" value="512" min="32" max="4096" step="32"></label>
      <select id="maxPreset" class="small">
        <option value="">â–¼ ãƒ—ãƒªã‚»ãƒƒãƒˆ</option>
        <option value="32">32ï¼ˆçŸ­æ–‡ï¼‰</option><option value="64">64ï¼ˆç°¡æ½”ï¼‰</option>
        <option value="256">256ï¼ˆèª¬æ˜ï¼‰</option><option value="1024">1024ï¼ˆé•·æ–‡ï¼‰</option>
        <option value="2048">2048ï¼ˆç‰©èªï¼‰</option>
      </select>
    </div>
    <div class="input-group">
      <label>æ¸©åº¦<input type="number" id="temp" value="0.7" min="0" max="1.5" step="0.1"></label>
      <select id="tempPreset" class="small">
        <option value="">â–¼ ç”¨é€”ã‚’é¸æŠ</option>
        <option value="0.2">è«–ç†å•é¡Œ</option><option value="0.3">è¦ç´„</option>
        <option value="0.4">ç¿»è¨³</option><option value="0.7">æ™®é€šã®ä¼šè©±ãƒ»èª¬æ˜æ–‡</option>
        <option value="0.9">è©©ãƒ»ç‰©èª</option><option value="1.1">ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆ</option>
        <option value="1.5">å®Ÿé¨“çš„</option>
      </select>
    </div>
    <div class="input-group" style="min-width:220px;">
      <button id="load">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿</button>
      <button id="clear">å±¥æ­´ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- ====== ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ + PDFæŠ½å‡º ====== -->
  <div class="panel" style="margin-top:12px;">
    <b>ğŸ“‚ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</b> <span class="hint">ï¼ˆTXT/MD/JSON/CSV/LOG/HTML/XML/YAML/PDFï¼‰</span>
    <div class="toolbar" style="margin-top:8px;">
      <div class="input-group" style="min-width:360px;">
        <label>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
          <input type="file" id="fileInput" multiple
                 accept=".txt,.md,.markdown,.json,.csv,.log,.html,.xml,.yaml,.yml,.pdf" />
        </label>
        <div id="drop" class="dropzone">ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚OK</div>
      </div>
      <div class="input-group">
        <label>ãƒãƒ£ãƒ³ã‚¯ä¸Šé™ï¼ˆæ–‡å­—ï¼‰
          <input type="number" id="chunkChars" value="2000" min="500" max="20000" step="500">
        </label>
        <span class="hint">â€» 1ãƒãƒ£ãƒ³ã‚¯ï¼ã“ã®é•·ã•ã§åˆ†å‰²ã€‚æ—¥æœ¬èªã¯ãŠãŠã‚ˆã2æ–‡å­—=1ãƒˆãƒ¼ã‚¯ãƒ³ã€‚</span>
      </div>
      <div class="input-group" style="min-width:280px;">
        <label>æ“ä½œ</label>
        <div class="toolbar">
          <button id="reindex" class="small">ç´¢å¼•ã‚’å†æ§‹ç¯‰</button>
          <button id="summAll" class="small">å…¨éƒ¨è¦ç´„ï¼ˆmap-reduceï¼‰</button>
          <button id="summSel" class="small">é¸æŠè¦ç´„</button>
        </div>
      </div>
    </div>

    <div class="list" id="docList"></div>

    <div class="toolbar" style="margin-top:10px;">
      <div class="input-group" style="min-width:680px;">
        <label>ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è³ªå•ï¼ˆRAGï¼‰</label>
        <input id="ragQuery" placeholder="ä¾‹ï¼šã“ã®è³‡æ–™ã®çµè«–ã‚’æ—¥æœ¬èªã§è¦ç´„ã—ã¦" />
      </div>
      <button id="askRag">è³ªå•ã™ã‚‹ï¼ˆé–¢é€£ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•æ·»ä»˜ï¼‰</button>
    </div>
  </div>

  <!-- ====== ãƒãƒ£ãƒƒãƒˆ ====== -->
  <div id="progress" hidden><div id="bar"></div></div>
  <div id="log"></div>
  <textarea id="input" placeholder="é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã¯ã“ã¡ã‚‰ã€‚Enterã§é€ä¿¡"></textarea>
  <button id="send" style="margin-top:8px;">é€ä¿¡</button>
</main>

<script type="module">
  // ===== ä¾å­˜ï¼šWebLLM ã¨ pdf.jsï¼ˆES Moduleï¼‰ =====
  import { CreateMLCEngine, prebuiltAppConfig } from "https://esm.run/@mlc-ai/web-llm@0.2.63";
  import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.mjs";
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

  const appConfig = prebuiltAppConfig;

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const gpu=$("#gpu"), modelSel=$("#model"), onlyDownloaded=$("#onlyDownloaded"),
        refreshBtn=$("#refresh"), maxTokensEl=$("#maxTokens"), tempEl=$("#temp"),
        maxPreset=$("#maxPreset"), tempPreset=$("#tempPreset"), loadBtn=$("#load"),
        clearBtn=$("#clear"), sendBtn=$("#send"), input=$("#input"),
        progress=$("#progress"), bar=$("#bar"), log=$("#log");
  const fileInput=$("#fileInput"), drop=$("#drop"), chunkCharsEl=$("#chunkChars"),
        docList=$("#docList"), reindexBtn=$("#reindex"),
        summAllBtn=$("#summAll"), summSelBtn=$("#summSel"),
        ragQuery=$("#ragQuery"), askRagBtn=$("#askRag");

  gpu.textContent = navigator.gpu ? "GPU: WebGPU åˆ©ç”¨å¯èƒ½" : "GPU: WebGPU éå¯¾å¿œ";
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.warn);

  // ===== ãƒ¢ãƒ‡ãƒ«é¸æŠï¼ˆ7Bã¾ã§ + â˜…ä¸Šä½ï¼‰ =====
  function human(id){ return id.replace(/[-_]/g,' ').replace(/ q(\d)/i,' q$1'); }
  function sizeB(id){ const m = id.match(/-(\d+(?:\.\d+)?)\s*[bB]/); return m?parseFloat(m[1]):null; }
  const LS_KEY='downloaded_models';
  const getLocalDownloaded=()=>new Set(JSON.parse(localStorage.getItem(LS_KEY)||'[]'));
  const saveLocalDownloaded=set=>localStorage.setItem(LS_KEY,JSON.stringify([...set]));
  async function guessDownloadedByIndexedDB(ids){
    const found=new Set();
    try{
      if(!('databases' in indexedDB)) return found;
      const dbs=await indexedDB.databases(); const names=(dbs||[]).map(d=>(d.name||'').toLowerCase());
      for(const id of ids){ const key=id.toLowerCase(); if(names.some(n=>n.includes(key))) found.add(id); }
    }catch{} return found;
  }
  async function rebuildMenu(){
    const all=(appConfig.model_list||[]).map(m=>m?.model_id).filter(Boolean)
      .filter(id=>{const s=sizeB(id); return (s==null||s<=7.01); });
    const isPref=id=>/(-Instruct-|[-_.]it[-_.])/i.test(id)&&/q4/i.test(id);
    const orderBySize=(a,b)=>(sizeB(a)??99)-(sizeB(b)??99);

    const local=getLocalDownloaded(), idxdb=await guessDownloadedByIndexedDB(all);
    const downloaded=new Set([...local,...idxdb]);

    const ordered=[...all].sort((a,b)=>{
      const r=(downloaded.has(a)?0:1)-(downloaded.has(b)?0:1); if(r!==0) return r;
      const p=(isPref(a)?0:1)-(isPref(b)?0:1); if(p!==0) return p;
      return orderBySize(a,b);
    });

    modelSel.innerHTML='';
    const ogDL=document.createElement('optgroup'); ogDL.label='â˜… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆ7Bã¾ã§ï¼‰';
    const ogAll=document.createElement('optgroup'); ogAll.label='ã™ã¹ã¦ï¼ˆ7Bã¾ã§ï¼‰';
    for(const id of ordered){
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=downloaded.has(id)?`${human(id)} â˜…`:human(id);
      (downloaded.has(id)?ogDL:ogAll).appendChild(opt);
    }
    if(onlyDownloaded.checked) modelSel.appendChild(ogDL);
    else { modelSel.appendChild(ogDL); modelSel.appendChild(ogAll); }

    const last=localStorage.getItem('model_id');
    if(last&&[...modelSel.options].some(o=>o.value===last)) modelSel.value=last;
    if(!modelSel.value&&modelSel.options.length) modelSel.selectedIndex=0;
  }
  onlyDownloaded.addEventListener('change',rebuildMenu);
  refreshBtn.addEventListener('click',rebuildMenu);
  await rebuildMenu();

  // ===== LLM ã‚¨ãƒ³ã‚¸ãƒ³ =====
  let engine=null, chatHistory=[];
  function pushMessage(role,text){ const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div class="role">${role}</div><div class="bubble"></div>`;
    row.querySelector('.bubble').textContent=text; log.appendChild(row);
    row.scrollIntoView({behavior:'smooth',block:'end'}); }
  function setProgress(p){ progress.hidden=false; bar.style.width=`${Math.round(p*100)}%`;
    if(p>=1) setTimeout(()=>{progress.hidden=true;bar.style.width='0%';},400); }
  async function loadModel(){
    const id=modelSel.value; setProgress(0.01); pushMessage('system',`ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­: ${id}`);
    try{
      engine=await CreateMLCEngine(id,{appConfig,initProgressCallback:r=>{if(r.progress!=null)setProgress(r.progress);}});
      pushMessage('system',`æº–å‚™å®Œäº†: ${id}`);
      const set=getLocalDownloaded(); set.add(id); saveLocalDownloaded(set);
      localStorage.setItem('model_id',id); await rebuildMenu();
    }catch(e){ console.error(e); pushMessage('system',`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${String(e?.message||e)}`); throw e; }
  }
  async function send(){
    const text=input.value.trim(); if(!text) return; if(!engine) await loadModel();
    input.value=''; pushMessage('user',text); chatHistory.push({role:'user',content:text});
    const chunks=await engine.chat.completions.create({
      messages:chatHistory, stream:true,
      temperature:parseFloat(tempEl.value), max_tokens:parseInt(maxTokensEl.value,10),
    });
    let acc=''; pushMessage('assistant',''); const last=log.lastElementChild.querySelector('.bubble');
    for await (const ch of chunks){ const d=ch?.choices?.[0]?.delta?.content??''; if(d){acc+=d; last.textContent=acc;} }
    chatHistory.push({role:'assistant',content:acc});
  }
  loadBtn.addEventListener('click',loadModel);
  clearBtn.addEventListener('click',()=>{chatHistory=[];log.innerHTML='';});
  sendBtn.addEventListener('click',send);
  input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});

  maxPreset.addEventListener('change',e=>{if(e.target.value)maxTokensEl.value=e.target.value;e.target.selectedIndex=0;});
  tempPreset.addEventListener('change',e=>{if(e.target.value)tempEl.value=e.target.value;e.target.selectedIndex=0;});

  // ===== ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ï¼ˆPDFæŠ½å‡º + ãƒãƒ£ãƒ³ã‚¯åŒ– + ç´¢å¼•ï¼‰ =====
  const store = []; // {id,name,type,text,chunks:[{id,text,docId,idx}]}
  let index = null; // {df:Map, docs:[{id,terms:Map,len}], inv:Map(term -> [{docId,chunkIdx,tf}])}

  function looksTextFile(name){ return /\.(txt|md|markdown|json|csv|log|html?|xml|ya?ml)$/i.test(name); }
  function uid(){ return Math.random().toString(36).slice(2); }

  function renderDocList(){
    const rows = store.map((d,i)=>(
      `<tr>
        <td><input type="checkbox" class="sel" data-i="${i}"></td>
        <td>${d.name}</td>
        <td>${d.type}</td>
        <td>${(d.text.length/1024).toFixed(1)} KB</td>
        <td>${d.chunks.length}</td>
      </tr>`)).join('');
    docList.innerHTML =
      `<table><thead><tr><th></th><th>åå‰</th><th>ã‚¿ã‚¤ãƒ—</th><th>ã‚µã‚¤ã‚º</th><th>ãƒãƒ£ãƒ³ã‚¯</th></tr></thead>
        <tbody>${rows||'<tr><td colspan="5" class="hint" style="padding:10px">æœªå–ã‚Šè¾¼ã¿</td></tr>'}</tbody></table>`;
  }

  function chunkText(txt, size){ const out=[]; for(let i=0;i<txt.length;i+=size){ out.push(txt.slice(i,i+size)); } return out; }

  async function parsePDF(file){
    const arr = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({data:arr}).promise;
    let text=''; for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const pageText = content.items.map(it=>('str' in it)?it.str:'').join('');
      text += `\n\n=== Page ${p} ===\n` + pageText;
    }
    return text;
  }

  async function handleFiles(files){
    const size = parseInt(chunkCharsEl.value||'2000',10);
    for(const file of files){
      let text='';
      if(looksTextFile(file.name)){ text = await file.text(); }
      else if(/\.pdf$/i.test(file.name)){ pushMessage('system',`PDFæŠ½å‡ºä¸­: ${file.name}`); text = await parsePDF(file); }
      else { pushMessage('system',`âš  éå¯¾å¿œã®æ‹¡å¼µå­: ${file.name}`); continue; }

      const docId=uid();
      const chunks=chunkText(text,size).map((t,idx)=>({id:uid(),text:t,docId,idx}));
      store.push({id:docId,name:file.name,type:file.type||(/\.pdf$/i.test(file.name)?'application/pdf':'text/plain'),text, chunks});
      pushMessage('system',`ğŸ“‚ å–ã‚Šè¾¼ã¿: ${file.name}ï¼ˆ${chunks.length} ãƒãƒ£ãƒ³ã‚¯ï¼‰`);
    }
    renderDocList();
  }

  fileInput.addEventListener('change',e=>{ if(e.target.files?.length) handleFiles(e.target.files); });
  ;['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag');}));
  drop.addEventListener('drop',e=>{ const files=[...(e.dataTransfer?.files||[])]; if(files.length) handleFiles(files); });

  // ===== ç´¢å¼•ï¼ˆè¶…è»½é‡TF-IDFï¼‰ =====
  function tokenize(s){ return s.toLowerCase().replace(/[^a-z0-9\u3040-\u30ff\u4e00-\u9fff]+/g,' ')
    .split(/\s+/).filter(t=>t && t.length>1); }
  function buildIndex(){
    const df = new Map(); const docs=[]; const inv=new Map();
    const allChunks = store.flatMap(d=>d.chunks);
    allChunks.forEach((c,idx)=>{
      const terms = new Map(); tokenize(c.text).forEach(t=>terms.set(t,(terms.get(t)||0)+1));
      terms.forEach((tf,t)=>{ df.set(t,(df.get(t)||0)+1); });
      docs.push({id:idx, terms, len: c.text.length});
    });
    df.forEach((_,t)=>inv.set(t,[]));
    docs.forEach((d,chunkIdx)=>{
      d.terms.forEach((tf,t)=>{ inv.get(t).push({docId:chunkIdx, tf}); });
    });
    index = {df,docs,inv,N:docs.length};
  }
  function scoreQuery(q){
    if(!index) return [];
    const qterms = tokenize(q); const scores=new Map();
    qterms.forEach(t=>{
      const df=index.df.get(t)||0; if(!df) return;
      const idf=Math.log((index.N+1)/(df+1))+1;
      const postings=index.inv.get(t)||[];
      postings.forEach(p=>{
        const s=(scores.get(p.docId)||0)+p.tf*idf;
        scores.set(p.docId,s);
      });
    });
    // ä¸Šä½k
    return [...scores.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(([i,sc])=>({idx:i,score:sc}));
  }

  reindexBtn.addEventListener('click',()=>{ buildIndex(); pushMessage('system',`ğŸ”§ ç´¢å¼•ã‚’å†æ§‹ç¯‰ã—ã¾ã—ãŸï¼ˆ${index?.N||0} ãƒãƒ£ãƒ³ã‚¯ï¼‰`); });

  // ===== è¦ç´„ï¼ˆmap-reduceï¼‰ =====
  async function summarizeChunks(chunks, title){
    if(!engine) await loadModel();
    // map: å„ãƒãƒ£ãƒ³ã‚¯è¦ç´„
    const partial=[]; let n=0;
    for(const ch of chunks){
      const prompt =
        `æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¥æœ¬èªã§150ã€œ250å­—ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n---\n${ch.text}\n---`;
      const res = await engine.chat.completions.create({
        messages:[{role:'user',content:prompt}], stream:false,
        temperature:0.3, max_tokens:512
      });
      const content = res?.choices?.[0]?.message?.content || '';
      partial.push(`â— ${content}`);
      n++; if(n%3===0) pushMessage('system',`è¦ç´„é€²è¡Œ: ${n}/${chunks.length}`);
    }
    // reduce: çµ±åˆè¦ç´„
    const reducePrompt =
      `ä»¥ä¸‹ã¯è¤‡æ•°æ–­ç‰‡ã®è¦ç´„ã§ã™ã€‚é‡è¤‡ã‚’é™¤ãã€é‡è¦ç‚¹ãƒ»çµè«–ãƒ»æ•°å€¤ãƒ»æ³¨æ„ç‚¹ã‚’æŠ½å‡ºã—ã¦æ—¥æœ¬èªã§300ã€œ500å­—ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n---\n${partial.join('\n')}\n---`;
    const final = await engine.chat.completions.create({
      messages:[{role:'user',content:reducePrompt}], stream:false,
      temperature:0.3, max_tokens:512
    });
    const text = final?.choices?.[0]?.message?.content || '';
    pushMessage('assistant', `ã€è¦ç´„: ${title}ã€‘\n${text}`);
  }

  summAllBtn.addEventListener('click',async ()=>{
    const chunks = store.flatMap(d=>d.chunks);
    if(!chunks.length){ pushMessage('system','è¦ç´„å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    await summarizeChunks(chunks,'å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ');
  });
  summSelBtn.addEventListener('click',async ()=>{
    const checks=[...docList.querySelectorAll('.sel')].filter(x=>x.checked);
    if(!checks.length){ pushMessage('system','é¸æŠãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const idx=checks.map(x=>parseInt(x.dataset.i,10));
    const chunks = idx.flatMap(i=>store[i].chunks);
    await summarizeChunks(chunks, idx.map(i=>store[i].name).join(', '));
  });

  // ===== RAG: è³ªå•ã«é–¢é€£ãƒãƒ£ãƒ³ã‚¯ã‚’è‡ªå‹•æ·»ä»˜ã—ã¦è³ªå• =====
  askRagBtn.addEventListener('click', async ()=>{
    const q = ragQuery.value.trim(); if(!q){ pushMessage('system','è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if(!engine) await loadModel();
    if(!index) buildIndex();
    const hits = scoreQuery(q);
    if(!hits.length){ pushMessage('system','ç´¢å¼•ã«ãƒ’ãƒƒãƒˆã—ã¾ã›ã‚“ã§ã—ãŸï¼ˆå…ˆã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–ã‚Šè¾¼ã‚“ã§ç´¢å¼•ã‚’å†æ§‹ç¯‰ï¼‰'); return; }

    const allChunks = store.flatMap(d=>d.chunks);
    const context = hits.map((h,i)=>{
      const c = allChunks[h.idx];
      const name = (store.find(d=>d.id===c.docId)||{}).name || 'doc';
      return `ã€#${i+1} ${name} / part ${c.idx+1}ã€‘\n${c.text}`;
    }).join('\n\n');

    const systemHint = "ã‚ãªãŸã¯ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã®ã¿ã‚’æ ¹æ‹ ã«æ—¥æœ¬èªã§ç­”ãˆã¾ã™ã€‚æœªçŸ¥ã®ç‚¹ã¯æ­£ç›´ã«ã€Œè³‡æ–™ã«ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã¨è¿°ã¹ã¦ãã ã•ã„ã€‚";
    pushMessage('user', `è³ªå•: ${q}\n\nå‚è€ƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰:\n${context.slice(0,8000)}`);

    const chunks = await engine.chat.completions.create({
      messages:[
        {role:'system', content: systemHint},
        {role:'user', content: `è³ªå•: ${q}\n\næ¬¡ã®è³‡æ–™ã‚’æ ¹æ‹ ã«ã€è¦ç‚¹/æ ¹æ‹ å‡ºå…¸ç•ªå·ã¤ãã§ç­”ãˆã¦ãã ã•ã„ã€‚\nè³‡æ–™:\n${context}`}
      ],
      stream:true, temperature:0.3, max_tokens:768
    });

    let acc=''; pushMessage('assistant','');
    const last=log.lastElementChild.querySelector('.bubble');
    for await (const ch of chunks){
      const d=ch?.choices?.[0]?.delta?.content ?? '';
      if(d){ acc+=d; last.textContent=acc; }
    }
    chatHistory.push({role:'assistant', content:acc});
  });

  // åˆæœŸæç”»
  (function init(){ renderDocList(); })();
</script>
</body>
</html>
