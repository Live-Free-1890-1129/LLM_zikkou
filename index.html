<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browser LLM Chat</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#0b0b0c; color:#f1f1f3; }
    header { background:#111; padding:14px 20px; border-bottom:1px solid #222; }
    main { max-width:900px; margin:0 auto; padding:20px; }
    select, input, button, textarea {
      background:#161618; color:#f1f1f3; border:1px solid #2a2a2f; border-radius:10px;
      padding:10px; font-size:14px;
    }
    textarea { width:100%; min-height:80px; resize:vertical; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start; }
    .input-group { display:flex; flex-direction:column; }
    .dropdown { margin-top:4px; font-size:13px; }
    .dropdown option { background:#101012; color:#f1f1f3; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .role { width:80px; color:#aaa; font-size:12px; text-transform:uppercase; }
    .bubble { background:#131316; border:1px solid #2a2a2f; border-radius:14px; padding:10px 14px; flex:1; white-space:pre-wrap; }
    #progress { height:6px; background:#1a1a1d; border-radius:3px; overflow:hidden; margin:8px 0; }
    #bar { height:100%; width:0%; background:#4da3ff; transition:width .25s ease; }
  </style>
</head>
<body>
  <header><b>Browser LLM Chat</b> <span style="font-size:12px;color:#888">WebGPUでローカル推論</span></header>
  <main>
    <div class="toolbar">
      <div class="input-group">
        <label>モデル<select id="model"></select></label>
      </div>
      <div class="input-group">
        <label>最大トークン<input type="number" id="maxTokens" value="512" min="32" max="2048" step="32"></label>
        <select id="maxPreset" class="dropdown">
          <option value="">▼ プリセット選択</option>
          <option value="32">32（短文）</option>
          <option value="64">64（簡潔）</option>
          <option value="256">256（説明）</option>
          <option value="1024">1024（長文）</option>
          <option value="2048">2048（物語）</option>
        </select>
      </div>
      <div class="input-group">
        <label>温度<input type="number" id="temp" value="0.7" min="0" max="1.5" step="0.1"></label>
        <select id="tempPreset" class="dropdown">
          <option value="">▼ 用途を選択</option>
          <option value="0.2">論理問題</option>
          <option value="0.3">要約</option>
          <option value="0.4">翻訳</option>
          <option value="0.7">普通の会話・説明文</option>
          <option value="0.9">詩・物語</option>
          <option value="1.1">アイデア生成</option>
          <option value="1.5">実験的</option>
        </select>
      </div>
      <button id="load">モデル読み込み</button>
      <button id="clear">履歴クリア</button>
    </div>

    <div id="progress" hidden><div id="bar"></div></div>
    <div id="log"></div>

    <textarea id="input" placeholder="メッセージを入力して Enter"></textarea>
    <button id="send" style="margin-top:8px;">送信</button>
  </main>

  <script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm@0.2.63";

    const modelSel = document.getElementById("model");
    const loadBtn = document.getElementById("load");
    const clearBtn = document.getElementById("clear");
    const sendBtn = document.getElementById("send");
    const input = document.getElementById("input");
    const progress = document.getElementById("progress");
    const bar = document.getElementById("bar");
    const log = document.getElementById("log");

    const maxTokensEl = document.getElementById("maxTokens");
    const tempEl = document.getElementById("temp");
    const maxPreset = document.getElementById("maxPreset");
    const tempPreset = document.getElementById("tempPreset");

    const models = [
      // 軽量
      "Phi-3.5-mini-instruct-q4f16_1-MLC",
      "Phi-3.5-mini-instruct-q4f16_1-MLC-1k",
      "Gemma-2-2b-it-q4f16_1-MLC",
      // 7Bクラス（強力）
      "Mistral-7B-Instruct-q4f16_1-MLC",
      "Qwen2.5-7B-Instruct-q4f16_1-MLC",
      "Llama-3.2-8B-Instruct-q4f16_1-MLC"
    ];

    models.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      modelSel.appendChild(opt);
    });

    let engine = null;
    let chatHistory = [];

    // UI動作
    maxPreset.onchange = e => { if (e.target.value) maxTokensEl.value = e.target.value; e.target.selectedIndex=0; };
    tempPreset.onchange = e => { if (e.target.value) tempEl.value = e.target.value; e.target.selectedIndex=0; };

    function pushMessage(role, text) {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `<div class="role">${role}</div><div class="bubble">${text}</div>`;
      log.appendChild(row);
      row.scrollIntoView({ behavior:"smooth", block:"end" });
    }

    function setProgress(p) {
      progress.hidden = false;
      bar.style.width = `${Math.round(p*100)}%`;
      if (p >= 1) setTimeout(()=>{progress.hidden=true;bar.style.width="0%";},400);
    }

    async function loadModel() {
      const id = modelSel.value;
      pushMessage("system", `モデル読み込み中: ${id}`);
      engine = await CreateMLCEngine(id, {
        initProgressCallback: (r)=>{ if (r.progress) setProgress(r.progress); }
      });
      pushMessage("system", `準備完了: ${id}`);
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      if (!engine) await loadModel();

      pushMessage("user", text);
      chatHistory.push({ role:"user", content:text });
      input.value = "";

      const chunks = await engine.chat.completions.create({
        messages: chatHistory,
        stream: true,
        temperature: parseFloat(tempEl.value),
        max_tokens: parseInt(maxTokensEl.value,10)
      });

      let acc = "";
      pushMessage("assistant", "");
      const last = log.lastElementChild.querySelector(".bubble");
      for await (const ch of chunks) {
        const delta = ch?.choices?.[0]?.delta?.content ?? "";
        if (delta) { acc += delta; last.textContent = acc; }
      }
      chatHistory.push({ role:"assistant", content:acc });
    }

    loadBtn.onclick = loadModel;
    clearBtn.onclick = ()=>{ log.innerHTML=""; chatHistory=[]; };
    sendBtn.onclick = send;
    input.addEventListener("keydown", e=>{ if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();} });
  </script>
</body>
</html>

