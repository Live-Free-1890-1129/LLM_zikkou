# index.html

```html
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browser LLM Chat</title>
  <style>
    :root { --bg:#0b0b0c; --panel:#111; --border:#222; --ink:#f1f1f3; --muted:#9aa0a6; --chip:#2a2a2f; --bubble:#131316; --accent:#4da3ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--ink); }
    header { background:var(--panel); padding:14px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;}
    main { max-width:980px; margin:0 auto; padding:20px; }
    select, input, button, textarea { background:#161618; color:var(--ink); border:1px solid var(--chip); border-radius:10px; padding:10px; font-size:14px; }
    textarea { width:100%; min-height:80px; resize:vertical; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start; }
    .input-group { display:flex; flex-direction:column; min-width:260px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .role { width:84px; color:#aaa; font-size:12px; text-transform:uppercase; }
    .bubble { background:var(--bubble); border:1px solid var(--chip); border-radius:14px; padding:10px 14px; flex:1; white-space:pre-wrap; }
    #progress { height:6px; background:#1a1a1d; border-radius:3px; overflow:hidden; margin:8px 0; }
    #bar { height:100%; width:0%; background:var(--accent); transition:width .25s ease; }
    .hint { color:var(--muted); font-size:12px; }
    .small { font-size:12px; padding:6px 8px; border-radius:8px; }
    optgroup[label] { color:#b6c8ff; font-weight:600; font-style:normal; }
    .banner { background:#2a1b1b; border:1px solid #6a3b3b; padding:10px; border-radius:10px; margin:10px 0; }
  </style>
</head>
<body>
  <header>
    <div><b>Browser LLM Chat</b> <span class="hint">（WebGPUでローカル推論）</span></div>
    <div id="gpu" class="hint">GPU: 検出中…</div>
  </header>

  <main>
    <div id="envBanner"></div>

    <div class="toolbar">
      <div class="input-group" style="min-width:360px;">
        <label>モデル
          <select id="model"></select>
        </label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px;">
          <label class="hint"><input type="checkbox" id="onlyDownloaded"> ダウンロード済みのみ表示</label>
          <button id="refresh" class="small">再スキャン</button>
          <span class="hint">★=ダウンロード済み / 7Bまで自動抽出</span>
        </div>
      </div>

      <div class="input-group">
        <label>最大トークン
          <input type="number" id="maxTokens" value="512" min="32" max="4096" step="32">
        </label>
        <select id="maxPreset" class="small">
          <option value="">▼ プリセット</option>
          <option value="32">32（短文）</option>
          <option value="64">64（簡潔）</option>
          <option value="256">256（数行の説明）</option>
          <option value="1024">1024（長文）</option>
          <option value="2048">2048（物語級）</option>
        </select>
      </div>

      <div class="input-group">
        <label>温度
          <input type="number" id="temp" value="0.7" min="0" max="1.5" step="0.1">
        </label>
        <select id="tempPreset" class="small">
          <option value="">▼ 用途を選択</option>
          <option value="0.2">論理問題</option>
          <option value="0.3">要約</option>
          <option value="0.4">翻訳</option>
          <option value="0.7">普通の会話・説明文</option>
          <option value="0.9">詩・物語</option>
          <option value="1.1">アイデア生成</option>
          <option value="1.5">実験的にのみ推奨</option>
        </select>
      </div>

      <div class="input-group" style="min-width:220px;">
        <button id="load">モデル読み込み</button>
        <button id="clear">履歴クリア</button>
      </div>
    </div>

    <div id="progress" hidden><div id="bar"></div></div>
    <div id="log"></div>

    <textarea id="input" placeholder="メッセージを入力して Enter"></textarea>
    <button id="send" style="margin-top:8px;">送信</button>
  </main>

  <script type="module">
    import { CreateMLCEngine, prebuiltAppConfig } from "https://esm.run/@mlc-ai/web-llm@0.2.63";
    const appConfig = prebuiltAppConfig;

    const $ = s => document.querySelector(s);
    const gpu = $("#gpu");
    const modelSel = $("#model");
    const onlyDownloaded = $("#onlyDownloaded");
    const refreshBtn = $("#refresh");
    const maxTokensEl = $("#maxTokens");
    const tempEl = $("#temp");
    const maxPreset = $("#maxPreset");
    const tempPreset = $("#tempPreset");
    const loadBtn = $("#load");
    const clearBtn = $("#clear");
    const sendBtn = $("#send");
    const input = $("#input");
    const log = $("#log");
    const progress = $("#progress");
    const bar = $("#bar");
    const envBanner = $("#envBanner");

    // --- Service Worker（ファイル名を sw.js に統一）---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(console.warn);
    }

    // --- GPU 表示 ---
    gpu.textContent = navigator.gpu ? "GPU: WebGPU 利用可能（要HTTPS/localhost）" : "GPU: WebGPU 非対応";

    // ---- 7Bまで抽出 & ダウンロード済み検出 ----
    function human(id){ return id.replace(/[-_]/g,' ').replace(/ q(\d)/i,' q$1'); }
    function sizeB(id){
      const m = id.match(/-(\d+(?:\.\d+)?)\s*[bB]/);  // "-7B", "-3.1B" など
      return m ? parseFloat(m[1]) : null;
    }
    const LS_KEY = 'downloaded_models';
    const getLocalDownloaded = () => new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]'));
    const saveLocalDownloaded = set => localStorage.setItem(LS_KEY, JSON.stringify([...set]));
    async function guessDownloadedByIndexedDB(candidateIds){
      const found = new Set();
      try{
        if (!('databases' in indexedDB)) return found;
        const dbs = await indexedDB.databases();
        const names = (dbs||[]).map(d => (d.name||'').toLowerCase());
        for (const id of candidateIds){
          const key = id.toLowerCase();
          if (names.some(n => n.includes(key))) found.add(id);
        }
      }catch{}
      return found;
    }

    async function rebuildMenu(){
      const all = (appConfig.model_list||[])
        .map(m => m?.model_id).filter(Boolean)
        .filter(id => {
          const s = sizeB(id);
          return (s == null || s <= 7.01); // 7Bまで
        });

      const isPref = id => /(-Instruct-|[-_.]it[-_.])/i.test(id) && /q4/i.test(id);
      const orderBySize = (a,b) => {
        const sa = sizeB(a) ?? 99, sb = sizeB(b) ?? 99;
        return sa - sb;
      };

      const local = getLocalDownloaded();
      const idxdb = await guessDownloadedByIndexedDB(all);
      const downloaded = new Set([...local, ...idxdb]);

      const ordered = [...all].sort((a,b)=>{
        const r = (downloaded.has(a)?0:1) - (downloaded.has(b)?0:1);
        if (r !== 0) return r;
        const p = (isPref(a)?0:1) - (isPref(b)?0:1);
        if (p !== 0) return p;
        return orderBySize(a,b);
      });

      modelSel.innerHTML = '';
      const ogDL = document.createElement('optgroup'); ogDL.label = '★ ダウンロード済み（7Bまで）';
      const ogAll = document.createElement('optgroup'); ogAll.label = 'すべて（7Bまで）';

      for (const id of ordered){
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = downloaded.has(id) ? `${human(id)} ★` : human(id);
        (downloaded.has(id) ? ogDL : ogAll).appendChild(opt);
      }

      if (onlyDownloaded.checked) {
        modelSel.appendChild(ogDL);
      } else {
        modelSel.appendChild(ogDL);
        modelSel.appendChild(ogAll);
      }

      const last = localStorage.getItem('model_id');
      if (last && [...modelSel.options].some(o=>o.value===last)) modelSel.value = last;
      if (!modelSel.value && modelSel.options.length) modelSel.selectedIndex = 0;
    }

    onlyDownloaded.addEventListener('change', rebuildMenu);
    refreshBtn.addEventListener('click', rebuildMenu);
    await rebuildMenu();

    // ---- プリセット反映 ----
    maxPreset.addEventListener('change', e => { if (e.target.value) maxTokensEl.value = e.target.value; e.target.selectedIndex=0; });
    tempPreset.addEventListener('change', e => { if (e.target.value) tempEl.value = e.target.value; e.target.selectedIndex=0; });

    // ---- チャット処理 ----
    let engine = null;
    let chatHistory = [];

    function pushMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<div class="role">${role}</div><div class="bubble"></div>`;
      row.querySelector('.bubble').textContent = text;
      log.appendChild(row);
      row.scrollIntoView({ behavior:'smooth', block:'end' });
    }
    function setProgress(p){
      progress.hidden = false;
      bar.style.width = `${Math.round(p*100)}%`;
      if (p>=1) setTimeout(()=>{ progress.hidden=true; bar.style.width='0%'; }, 400);
    }

    // ---- 環境チェック＆案内 ----
    function explainAndDisable(reason) {
      const banner = document.createElement('div');
      banner.className = 'banner';
      banner.innerHTML = [
        '⚠️ WebGPU を利用できないため、ローカル推論を開始できません。',
        `<div style="color:#ddd;margin-top:6px;">${reason}</div>`,
        '<ul style="margin:8px 0 0 18px;color:#bbb;font-size:13px;line-height:1.5;">' +
          '<li>対応ブラウザ（Chrome/Edge/Safari 最新版など）を使用</li>' +
          '<li>デスクトップ環境で実行（iOS Safari は未対応）</li>' +
          '<li>HTTPS または localhost で配信</li>' +
          '<li>社内ポリシーや拡張機能で WebGPU がブロックされていないか確認</li>' +
          '<li>（古い Chrome 系）chrome://flags で <b>Unsafe WebGPU</b> を有効化</li>' +
        '</ul>'
      ].join('');
      envBanner.replaceChildren(banner);

      loadBtn.disabled = true;
      sendBtn.disabled = true;
      loadBtn.textContent = 'WebGPU未利用のため無効';
    }

    async function ensureWebGPU() {
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isSecure) {
        explainAndDisable('このページは HTTPS（または localhost）で配信されていません。');
        return false;
      }
      if (!('gpu' in navigator)) {
        explainAndDisable('このブラウザは navigator.gpu を提供していません（WebGPU未対応）。');
        return false;
      }
      try {
        const adapter = await navigator.gpu.requestAdapter();
        if (!adapter) {
          explainAndDisable('GPU アダプタが取得できません（ドライバや権限の問題の可能性）。');
          return false;
        }
      } catch (e) {
        explainAndDisable('WebGPU 初期化でエラーが発生しました。ブラウザ設定や拡張機能を確認してください。');
        return false;
      }
      return true;
    }

    // ---- モデル読み込み ----
    async function loadModel() {
      const ok = await ensureWebGPU();
      if (!ok) return;

      const modelId = modelSel.value;
      setProgress(0.01);
      pushMessage('system', `モデル読み込み中: ${modelId}`);
      try{
        engine = await CreateMLCEngine(modelId, {
          appConfig,
          initProgressCallback: r => { if (r.progress != null) setProgress(r.progress); }
        });
        pushMessage('system', `準備完了: ${modelId}`);
        const set = getLocalDownloaded(); set.add(modelId); saveLocalDownloaded(set);
        localStorage.setItem('model_id', modelId);
        await rebuildMenu();
      }catch(e){
        console.error(e);
        pushMessage('system', `読み込みエラー: ${String(e?.message||e)}\n→ WebGPU が無効/ブロックされていないか、配信元が HTTPS か確認してください。`);
      }
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      if (!engine) await loadModel();
      if (!engine) return; // 環境NG時は何もしない

      input.value = '';
      pushMessage('user', text);
      chatHistory.push({ role:'user', content:text });

      const chunks = await engine.chat.completions.create({
        messages: chatHistory,
        stream: true,
        temperature: parseFloat(tempEl.value),
        max_tokens: parseInt(maxTokensEl.value,10),
      });

      let acc = '';
      pushMessage('assistant','');
      const last = log.lastElementChild.querySelector('.bubble');

      for await (const ch of chunks){
        const delta = ch?.choices?.[0]?.delta?.content ?? '';
        if (delta){ acc += delta; last.textContent = acc; }
      }
      chatHistory.push({ role:'assistant', content:acc });
    }

    loadBtn.addEventListener('click', loadModel);
    clearBtn.addEventListener('click', ()=>{ chatHistory=[]; log.innerHTML=''; });
    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

    // 起動時チェック
    (async () => {
      const ok = await ensureWebGPU();
      gpu.textContent = ok ? 'GPU: WebGPU 利用可能' : 'GPU: WebGPU 未利用（上の案内を参照）';
    })();
  </script>
</body>
</html>
```

---

# sw.js

```js
const CACHE = 'browser-llm-v2';
const STATIC_ASSETS = ['/', '/index.html', '/sw.js'];

self.addEventListener('install', (e) => {
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(STATIC_ASSETS)));
  self.skipWaiting();
});

self.addEventListener('activate', (e) => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
    )
  );
  self.clients.claim();
});

self.addEventListener('fetch', (event) => {
  const req = event.request;
  if (req.method !== 'GET') return;

  // 同一オリジンのみ。CDN等のモデル取得は妨げない
  const url = new URL(req.url);
  if (url.origin !== self.location.origin) return;

  event.respondWith((async () => {
    try {
      const net = await fetch(req);
      const cache = await caches.open(CACHE);
      cache.put(req, net.clone());
      return net;
    } catch {
      const cached = await caches.match(req);
      if (cached) return cached;
      if (req.mode === 'navigate') return caches.match('/index.html');
      throw new Error('offline and not cached');
    }
  })());
});
```
